---
# PreSync hook: generates infisical-secrets if it does not already exist.
# This is a bootstrap-only operation — keys are generated once and persist
# across upgrades. ENCRYPTION_KEY loss = unrecoverable data loss.
apiVersion: v1
kind: ServiceAccount
metadata:
  name: infisical-bootstrap
  namespace: infisical
  annotations:
    argocd.argoproj.io/hook: PreSync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: infisical-bootstrap
  namespace: infisical
  annotations:
    argocd.argoproj.io/hook: PreSync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
rules:
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["get", "create"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: infisical-bootstrap
  namespace: infisical
  annotations:
    argocd.argoproj.io/hook: PreSync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
subjects:
  - kind: ServiceAccount
    name: infisical-bootstrap
    namespace: infisical
roleRef:
  kind: Role
  name: infisical-bootstrap
  apiGroup: rbac.authorization.k8s.io
---
apiVersion: batch/v1
kind: Job
metadata:
  name: infisical-bootstrap-secrets
  namespace: infisical
  annotations:
    argocd.argoproj.io/hook: PreSync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
spec:
  backoffLimit: 3
  template:
    metadata:
      labels:
        app: infisical-bootstrap
    spec:
      serviceAccountName: infisical-bootstrap
      restartPolicy: Never
      containers:
        - name: bootstrap
          image: alpine:3.21
          resources:
            requests:
              cpu: 50m
              memory: 64Mi
            limits:
              cpu: 200m
              memory: 128Mi
          command:
            - sh
            - -ce
            - |
              apk add --no-cache openssl curl > /dev/null 2>&1

              # Install kubectl
              curl -sLo /usr/local/bin/kubectl \
                "https://dl.k8s.io/release/$(curl -sL https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
              chmod +x /usr/local/bin/kubectl

              # Check if secret already exists — skip if so (idempotent)
              if kubectl get secret infisical-secrets -n infisical > /dev/null 2>&1; then
                echo "Secret infisical-secrets already exists, skipping bootstrap."
                exit 0
              fi

              # Generate cryptographic keys
              ENCRYPTION_KEY=$(openssl rand -hex 16)
              AUTH_SECRET=$(openssl rand -base64 32)

              # Create the bootstrap secret
              kubectl create secret generic infisical-secrets \
                --namespace infisical \
                --from-literal=ENCRYPTION_KEY="$ENCRYPTION_KEY" \
                --from-literal=AUTH_SECRET="$AUTH_SECRET"

              echo "Bootstrap secret created successfully."
