---
# Bootstrap PreSync hook: generates Redis password if it does not exist.
apiVersion: v1
kind: ServiceAccount
metadata:
  name: redis-bootstrap
  namespace: redis
  annotations:
    argocd.argoproj.io/hook: PreSync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: redis-bootstrap
  namespace: redis
  annotations:
    argocd.argoproj.io/hook: PreSync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
rules:
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["get", "create"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: redis-bootstrap
  namespace: redis
  annotations:
    argocd.argoproj.io/hook: PreSync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
subjects:
  - kind: ServiceAccount
    name: redis-bootstrap
    namespace: redis
roleRef:
  kind: Role
  name: redis-bootstrap
  apiGroup: rbac.authorization.k8s.io
---
apiVersion: batch/v1
kind: Job
metadata:
  name: redis-bootstrap-password
  namespace: redis
  annotations:
    argocd.argoproj.io/hook: PreSync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
spec:
  backoffLimit: 3
  template:
    metadata:
      labels:
        app: redis-bootstrap
    spec:
      serviceAccountName: redis-bootstrap
      restartPolicy: Never
      containers:
        - name: bootstrap
          image: alpine:3.21
          resources:
            requests:
              cpu: 50m
              memory: 64Mi
            limits:
              cpu: 200m
              memory: 128Mi
          command:
            - sh
            - -ce
            - |
              apk add --no-cache openssl curl > /dev/null 2>&1
              curl -sLo /usr/local/bin/kubectl \
                "https://dl.k8s.io/release/$(curl -sL https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
              chmod +x /usr/local/bin/kubectl

              if kubectl get secret redis-password -n redis > /dev/null 2>&1; then
                echo "Secret redis-password already exists, skipping."
                exit 0
              fi

              PASSWORD=$(openssl rand -base64 24)
              kubectl create secret generic redis-password \
                --namespace redis \
                --from-literal=password="$PASSWORD"
              echo "Redis password secret created."
